<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>team</title>
</head>
<body>
<!-- 전체 영역-->
<div>
  <!--  도메인 입력 -->
  추가 주소입력
  <div style="height: 65px;width: 1033px; border:solid 1px; margin-bottom: 10px;">
    <br>
    <div>
      <div style="width:300px; margin-top: 1px; float:left;  border:solid 1px;">
        <label> 이름 </label><input id="addressUrlName" name="name" type="text"><br>
        <label> URL </label><input id="addressUrl" name="url" type="text">
        <button type="button" onclick="addressUrl()">추가</button>
      </div>
      <div style="width:400px;  margin-top: 1px; float:left; border:solid 1px;">
        <label> 이름 </label><input id="addressPortName" name="name" type="text" style="width:113px;"><br>
        <label> IP </label>
        <input id="addressPortIpA" name="addressPortIpA" type="number" max="255" min="0" style="width:40px;">.
        <input id="addressPortIpB" name="addressPortIpB" type="number" max="255" min="0" style="width:40px;">.
        <input id="addressPortIpC" name="addressPortIpC" type="number" max="255" min="0" style="width:40px;">.
        <input id="addressPortIpD" name="addressPortIpD" type="number" max="255" min="0" style="width:40px;">
        <label>port</label>
        <input id="addressPortPort" name="port" type="text" style="width:70px;">
        <button type="button" onclick="addressPort()">추가</button>
      </div>
      <div style="width:300px; margin-top: 1px; float:left; border:solid 1px; ">
        <div>
          <label> 이름 </label><input id="addressIpName" name="name" type="text" style="width: 100px;"><br>
          <label> IP </label>
          <input id="addressIpA" name="addressIpA" type="number" max="255" min="0" style="width:40px;">.
          <input id="addressIpB" name="addressIpB" type="number" max="255" min="0" style="width:40px;">.
          <input id="addressIpC" name="addressIpC" type="number" max="255" min="0" style="width:40px;">.
          <input id="addressIpD" name="addressIpD" type="number" max="255" min="0" style="width:40px;">
          <button type="button" onclick="addressIp()">추가</button>
        </div>
      </div>
    </div>
  </div>

  <div>
    <label>팀원 초대</label><br>
    <div style=" height:30px; width:280px; margin-top: 1px; float:left;  border:solid 1px;margin-bottom: 10px;">
      <label>초대 이메일 </label><input id="email" name="email" type="email">
      <input type="button" value="초대" onclick="postInviteTeam()">
    </div>
  </div>
  <br>
  <div>
    <!-- 도메인 영역 -->
    <label></label>
    <div id="connectDomain" style="height:auto; width:848px; float:left; margin-bottom:15px;">
    </div>
    <div style="width: 848px;/">
      <label style="float:left">팀원 연결 상태</label>
      <div style="width:848px;height: 1px;background-color:black;float:left">
      </div>
    </div>
    <!-- 팀원 영역 -->
    <div id="connectMember" style="width:848px;">
    </div>
  </div>
</div>
</body>
<script>

  const defaultUrl = window.location.href;
  const local = window.location.pathname;
  const param = local.substring(11, local.length);
  const params = param.split('/');
  const groupId = params[0];
  const teamId = params[1];

  const init = function () {
    findDomain();
    findMember();
    pingDomain();
    pingMember();
  }

  function findDomain() {
    post("api/team/find/domain/" + teamId)
    .then((datas) => {
      var out = "";
      datas.forEach(function (data) {
        let name = data.name;
        let id = data.id;
        out += ""
            + " <div style='border:solid 1px; width:200px;height: 60px;float: left;margin-right:10px;'>\n"
            + "   <label id ='domain_address_" + id + "'>주소 : [ " + name + " ]</label><br>\n"
            + "   <label id ='domain_status_" + id + "'>연결 상태 : 대기중 </label>\n"
            + " </div>";
      })
      document.getElementById("connectDomain")
          .innerHTML = out;
    })
    .catch(error => console.log(error))
  }

  function findMember() {
    post("api/team/find/member/" + teamId)
    .then((datas) => {
      var out = "";
      datas.forEach(function (data) {
        let name = data.name;
        let id = data.id;
        out += ""
            + "<div style='border:solid 1px; width:200px;height: 23px;float: left;margin-right:10px;margin-top:3px;'>\n"
            + "    <label id='member_name_" + id + "' style='float:left; margin-left:5px;'>" + name + "</label>\n"
            + "    <label id='member_status_" + id + "' style='float:right; margin-right:5px;'> 연결 상태: 대기중 </label>\n"
            + "</div>";
      })
      document.getElementById("connectMember")
          .innerHTML = out;
    })
    .catch(error => console.log(error))
  }

  function pingDomain() {
    post("api/team/ping/domain/" + teamId)
    .then(data => divConnectDomain(data))
    .catch(error => console.log(error))
  }

  function pingMember() {
    post("api/team/ping/member/" + teamId)
    .then((data) => divConnectMember(data))
    .catch(error => console.log(error))
  }

  function divConnectDomain(datas) {
    datas.forEach(function (data) {
      let address = data.name;
      let status = data.status;
      let connectId = data.connectId;
      document.getElementById("domain_address_" + connectId).innerHTML = "주소 : [" + address + "]";
      document.getElementById("domain_status_" + connectId).innerHTML = "주소 : [" + status + "]";
    })
  }

  function divConnectMember(datas) {
    datas.forEach(function (data) {
      let userName = data.name;
      let status = data.status;
      let id = data.id;
      document.getElementById("mamber_name_" + id).innerHTML = userName;
      document.getElementById("mamber_status_" + id).innerHTML = "연결 상태: " + status + "";
    })
  }

  function addressUrl() {
    var name = document.getElementById("addressUrlName").value;
    var url = document.getElementById("addressUrl").value;
    postVoid("api/team/add/url", {
      teamId: teamId,
      name: name,
      url: url,
    })
    .then(() => {
      location.reload();
    })
    .catch(error => console.log(error))

  }

  function addressPort() {
    var name = document.getElementById("addressPortName").value;
    var port = document.getElementById("addressPortPort").value;
    var aClass = document.getElementById("addressPortIpA").value;
    var bClass = document.getElementById("addressPortIpB").value;
    var cClass = document.getElementById("addressPortIpC").value;
    var dClass = document.getElementById("addressPortIpD").value;

    console.log("hello");
    console.log(aClass + "." + bClass + "." + cClass + "." + dClass);
    post("api/team/add/ip/port", {
      teamId: teamId,
      name: name,
      a: aClass,
      b: bClass,
      c: cClass,
      d: dClass,
      port: port,
    })
    .then(() => {
      location.reload()
    })
    .catch(error => console.log(error))
  }

  function addressIp() {
    var name = document.getElementById("addressIpName").value;
    var AClass = document.getElementById("addressIpA").value;
    var BClass = document.getElementById("addressIpB").value;
    var CClass = document.getElementById("addressIpC").value;
    var DClass = document.getElementById("addressIpD").value;
    postVoid("api/team/add/ip/", {
      teamId: teamId,
      name: name,
      a: AClass,
      b: BClass,
      c: CClass,
      d: DClass,
    })
    .then(() => {
      location.reload()
    })
    .catch(error => console.log(error))
  }

  function postInviteTeam() {
    var email = document.getElementById("email").value;

    post("api/team/invite", {
      teamId: teamId,
      groupsId: groupId,
      email: email,
    })
    .then(() => {
      location.reload()
    })
    .catch(error => console.log(error))
  }

  async function post(path, body, headers = {}) {

    const url = `${defaultUrl}${path}`;
    const options = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...headers,
      },
      body: JSON.stringify(body),
    };
    const res = await fetch(url, options);
    const data = await res.json();
    if (res.ok) {
      return data;
    } else {
      throw Error(data);
    }
  }

  async function postVoid(path, body, headers = {}) {

    const url = `${defaultUrl}${path}`;
    const options = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...headers,
      },
      body: JSON.stringify(body),
    };
    const res = await fetch(url, options);
    if (res.ok) {
      return res.ok;
    } else {
      throw Error(data);
    }
  }

  init();
</script>
</html>